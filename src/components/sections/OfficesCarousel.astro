---
// OfficesCarousel.astro - Carrusel de oficinas
import { Image } from 'astro:assets';

// Importar imágenes de oficinas
import oficinaMedellin01 from '../../assets/images/offices/Oficinamedellin-01.jpg';
import oficinaMedellin02 from '../../assets/images/offices/Oficinamedellin-02.jpg';
import oficinaBogota01 from '../../assets/images/offices/Oficinabogota-01.jpg';
import oficinaBogota02 from '../../assets/images/offices/Oficinabogota-02.jpg';
import oficinaPereira01 from '../../assets/images/offices/Oficinapereira-01.jpg';
import oficinaPereira02 from '../../assets/images/offices/Oficinapereira-02.jpg';
import OfficeCard from "../ui/OfficeCard.astro";
---

<!-- Contamos con oficinas en -->
<section class="bg-servir-blue py-16 md:py-20 relative">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Título con fondo blanco redondo en la parte superior -->
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
            <div class="bg-white rounded-full px-12 py-6 shadow-lg">
                <h2 class="text-xl md:text-2xl lg:text-3xl font-bold whitespace-nowrap text-servir-blue" style="font-style:italic">
                    Contamos con oficinas en:
                </h2>
            </div>
        </div>

        <!-- Espaciado para el título -->
        <div class="pt-12 md:pt-16"></div>

        <!-- Carrusel de Cards de Oficinas -->
        <div class="relative">
            <!-- Contenedor del carrusel -->
            <div class="overflow-hidden" id="carousel-container">
              <div id="offices-carousel" class="flex transition-transform duration-300 ease-in-out">
                <OfficeCard
                    officeKey="envigado"
                    title="CC. Viva Envigado"
                    images={{ src1: oficinaPereira01, src2: oficinaPereira02, alt1: 'CC. Viva Envigado 1', alt2: 'CC. Viva Envigado 2' }}
                    mapUrl="https://maps.app.goo.gl/4ik33Hfv3dbTHbFv9"
                />
                <OfficeCard
                    officeKey="medellin"
                    title="Oficina en Medellín"
                    images={{ src1: oficinaMedellin01, src2: oficinaMedellin02, alt1: 'Oficina Medellín 1', alt2: 'Oficina Medellín 2' }}
                    mapUrl="https://maps.app.goo.gl/UXmTfssLjFP8LqVY9?g_st=awb"
                    details={["Carrera 51 #45-75", "CC. Pioneros - Local 213", "Centro de Medellín, La Candelaria"]}
                />
                <OfficeCard
                    officeKey="bogota"
                    title="Oficina en Bogotá"
                    images={{ src1: oficinaBogota01, src2: oficinaBogota02, alt1: 'Oficina Bogotá 1', alt2: 'Oficina Bogotá 2' }}
                    mapUrl="https://maps.app.goo.gl/xWVsig6u2rkvhwZ19?g_st=awb"
                    details={["Calle 13# 15-73", "CC. Nodo Móvil 13G - Oficina 206", "Centro de Bogotá, Los Mártires"]}
                />
                <OfficeCard
                    officeKey="pereira"
                    title="Oficina en Pereira"
                    images={{ src1: oficinaPereira01, src2: oficinaPereira02, alt1: 'Oficina Pereira 1', alt2: 'Oficina Pereira 2' }}
                    mapUrl="https://maps.app.goo.gl/hCAJopm3WZTepwaY9?g_st=ic"
                    details={["Carrera 8#19-41", "CC. Bolívar Plaza- Local 118", "Plaza Bolívar, Pereira"]}
                />
                </div>
             </div>
            </div>

            <!-- Botones de navegación en la parte inferior -->
            <div class="flex justify-center mt-8 space-x-4" id="offices-indicators">
                <button
                    class="office-indicator w-4 h-4 rounded-full bg-gray-300 shadow-lg border-2 border-white transition-all duration-300 hover:bg-gray-400 hover:scale-110 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"></button>
                <button
                    class="office-indicator w-4 h-4 rounded-full bg-gray-300 shadow-md border-2 border-white transition-all duration-300 hover:bg-gray-400 hover:scale-110 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"></button>
                <button
                    class="office-indicator w-4 h-4 rounded-full bg-gray-300 shadow-md border-2 border-white transition-all duration-300 hover:bg-gray-400 hover:scale-110 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"></button>
                <button
                    class="office-indicator w-4 h-4 rounded-full bg-gray-300 shadow-md border-2 border-white transition-all duration-300 hover:bg-gray-400 hover:scale-110 hover:shadow-lg focus:outline-next focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"></button>
            </div>
        </div>
    </div>
</section>

<script>
    // Variables globales para el carrusel principal
    let currentOfficeIndex = 0;
    const totalOffices = 4;

    // Auto-rotación del carrusel principal
    let autoTimer = null;
    const autoIntervalMs = 5000;

    // Variables para los carruseles de imágenes de cada oficina
    const imageIndexes = {
        'envigado': 0,
        'medellin': 0,
        'bogota': 0,
        'pereira': 0
    };

    // Función para cambiar de oficina
    function changeOffice(index) {
        const carousel = document.getElementById('offices-carousel');
        const container = document.getElementById('carousel-container');
        if (!carousel || !container) return;

        const cards = carousel.children;
        const maxIndex = Math.max(0, cards.length - 1);
        currentOfficeIndex = Math.min(Math.max(index, 0), maxIndex);

        // Obtener el ancho del contenedor (por si se necesita en el futuro)
        const containerWidth = container.offsetWidth;

        // Calcular el desplazamiento acumulado hasta la tarjeta seleccionada
        let totalOffset = 0;
        for (let i = 0; i < currentOfficeIndex; i++) {
            const card = cards[i];
            if (!card) break;
            totalOffset += card.offsetWidth + 16; // 16px = mx-2 (8px cada lado)
        }

        carousel.style.transform = `translateX(-${totalOffset}px)`;

        // Actualizar indicadores
        updateCarouselIndicators();
    }

    // Función para actualizar los indicadores del carrusel principal (scope Offices)
    function updateCarouselIndicators() {
        const buttons = document.querySelectorAll('#offices-indicators .office-indicator');
        buttons.forEach((btn, index) => {
            if (index === currentOfficeIndex) {
                // Color activo explicitamente requerido: #90C044
                btn.classList.remove('bg-gray-300');
                btn.classList.remove('bg-blue-600');
                btn.style.backgroundColor = '#90C044';
            } else {
                btn.style.backgroundColor = '';
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-300');
            }
        });
    }

    // Función para cambiar imagen anterior en el carrusel de fotos
    function previousImage(office) {
        const currentIndex = imageIndexes[office];
        const newIndex = currentIndex === 0 ? 1 : currentIndex - 1;
        imageIndexes[office] = newIndex;
        
        const imageCarousel = document.getElementById(`${office}-images`);
        const translateX = -newIndex * 50;
        imageCarousel.style.transform = `translateX(${translateX}%)`;
    }

    // Función para cambiar imagen siguiente en el carrusel de fotos
    function nextImage(office) {
        const currentIndex = imageIndexes[office];
        const newIndex = currentIndex === 1 ? 0 : currentIndex + 1;
        imageIndexes[office] = newIndex;
        
        const imageCarousel = document.getElementById(`${office}-images`);
        const translateX = -newIndex * 50;
        imageCarousel.style.transform = `translateX(${translateX}%)`;
    }

    // Inicializar el carrusel cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar los botones indicadores del carrusel principal (solo Offices)
        const carouselButtons = document.querySelectorAll('#offices-indicators .office-indicator');
        carouselButtons.forEach((btn, index) => {
            btn.addEventListener('click', () => changeOffice(index));
        });

        // Inicializar el primer indicador como activo
        updateCarouselIndicators();

        // Habilitar swipe táctil en móviles y arrastre en desktop para el carrusel de oficinas
        const container = document.getElementById('carousel-container');
        if (container) {
            let startX = 0;
            let isDragging = false;
            const threshold = 50; // píxeles para cambiar de slide

            const onTouchStart = (e) => {
                if (e.touches && e.touches.length > 0) {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                }
            };
            const onTouchMove = (e) => {
                if (!isDragging) return;
                // Prevenir el scroll vertical predominante cuando es un swipe horizontal
                e.preventDefault();
            };
            const onTouchEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : startX;
                const delta = endX - startX;
                if (Math.abs(delta) > threshold) {
                    // delta negativo: swipe a la izquierda -> siguiente oficina
                    const direction = delta < 0 ? 1 : -1;
                    changeOffice(currentOfficeIndex + direction);
                }
            };

            // Eventos táctiles
            container.addEventListener('touchstart', onTouchStart, { passive: false });
            container.addEventListener('touchmove', onTouchMove, { passive: false });
            container.addEventListener('touchend', onTouchEnd, { passive: false });

            // Opcional: soporte de mouse para desktop
            let mouseStartX = 0;
            const onMouseDown = (e) => { isDragging = true; mouseStartX = e.clientX; };
            const onMouseMove = (e) => { if (!isDragging) return; };
            const onMouseUp = (e) => {
                if (!isDragging) return;
                isDragging = false;
                const delta = e.clientX - mouseStartX;
                if (Math.abs(delta) > threshold) {
                    const direction = delta < 0 ? 1 : -1;
                    changeOffice(currentOfficeIndex + direction);
                }
            };
            container.addEventListener('mousedown', onMouseDown);
            container.addEventListener('mousemove', onMouseMove);
            container.addEventListener('mouseup', onMouseUp);
            container.addEventListener('mouseleave', onMouseUp);
        }

        // Configurar auto-rotación del carrusel de oficinas
        const startAuto = () => {
            if (autoTimer) clearInterval(autoTimer);
            autoTimer = setInterval(() => {
                const nextIndex = (currentOfficeIndex + 1) % totalOffices;
                changeOffice(nextIndex);
            }, autoIntervalMs);
        };
       // startAuto();
    });

    // Hacer las funciones globales para que funcionen con onclick
    window.previousImage = previousImage;
    window.nextImage = nextImage;
    window.changeOffice = changeOffice;
</script>